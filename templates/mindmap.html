<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inspiration Hub — Mindmap</title>
  <style>
    :root {
      --bg:#0f1724;--panel:#0b1220;--accent:#7c3aed;--muted:#94a3b8;--node:#0ea5a4
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Arial,sans-serif}
    body{margin:0;height:100vh;background:linear-gradient(180deg,var(--bg),#071024);color:#e6eef8;display:flex;flex-direction:column}
    header{display:flex;align-items:center;gap:12px;padding:12px 14px;background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent);box-shadow:0 1px 0 rgba(255,255,255,0.02);flex-wrap:wrap}
    header h1{font-size:18px;margin:0;flex:1}
    .toolbar{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px}
    .toolbar button{white-space:nowrap}
    button{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer;font-size:14px}
    button.primary{background:linear-gradient(90deg,var(--accent),#06b6d4);border:none;color:white}
    button:active{transform:translateY(1px)}
    .container{flex:1;display:flex;overflow:hidden}
    .left{width:260px;padding:16px;border-right:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);transition:transform .3s ease}
    .left h2{font-size:14px;margin:0 0 8px}
    .controls{display:flex;flex-direction:column;gap:8px}
    .controls input,.controls textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:#e6eef8}
    .canvas-wrap{flex:1;position:relative;overflow:hidden}
    canvas#edges{position:absolute;inset:0}
    .stage{position:absolute;inset:0}
    .node{position:absolute;padding:10px 12px;border-radius:10px;min-width:120px;max-width:260px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);cursor:grab;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    .node.dragging{cursor:grabbing;transform:scale(1.02)}
    .node .title{font-weight:600;margin-bottom:6px}
    .node .meta{font-size:12px;color:var(--muted)}
    .node .actions{margin-top:8px;display:flex;gap:6px}
    .small{font-size:12px;color:var(--muted)}
    .handle{width:12px;height:12px;border-radius:50%;background:var(--node);display:inline-block;margin-right:8px;vertical-align:middle}
    footer{position:absolute;right:12px;bottom:12px;color:var(--muted);font-size:12px}

    /* Responsive */
    @media (max-width:800px){
      .left{position:fixed;top:0;bottom:0;left:0;z-index:100;background:var(--panel);transform:translateX(-100%);max-width:80%;overflow-y:auto}
      .left.open{transform:translateX(0)}
      .container{flex-direction:column}
      .toolbar{order:2;width:100%}
      header h1{flex:none;width:100%;margin-bottom:6px}
      #toggleSidebar{display:inline-block}
    }
    #toggleSidebar{display:none}
  </style>
</head>
<body>
  <header>
    <button id="toggleSidebar">☰</button>
    <h1>Inspiration Hub — Mindmap</h1>
    <div class="toolbar">
      <button id="btnAdd">+ Node</button>
      <button id="btnConnect">Connect</button>
      <button id="btnDelete">Delete</button>
      <button id="btnSave" class="primary">Save</button>
      <button id="btnExport">Export JSON</button>
      <button id="btnImport">Import JSON</button>
    </div>
  </header>

  <div class="container">
    <aside class="left" id="sidebar">
      <h2>Node Details</h2>
      <div class="controls">
        <input id="nodeTitle" placeholder="Node title" />
        <textarea id="nodeDesc" rows="4" placeholder="Short description (optional)"></textarea>
        <div style="display:flex;gap:8px">
          <input id="color" type="color" value="#0ea5a4" style="width:48px;padding:4px" />
          <select id="fontSize">
            <option value="14">14px</option>
            <option value="16" selected>16px</option>
            <option value="18">18px</option>
          </select>
          <button id="apply" style="flex:1">Apply</button>
        </div>
        <div class="small">Tips: Drag nodes • Connect: click 2 nodes • Delete: click node</div>
        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03)">
        <button id="clearAll">Clear Map</button>
      </div>
    </aside>

    <div class="canvas-wrap">
      <canvas id="edges"></canvas>
      <div id="stage" class="stage"></div>
      <footer>Double-tap to add node • Auto-saves</footer>
    </div>
  </div>

  <script>
    // sidebar toggle
    document.getElementById("toggleSidebar").addEventListener("click",()=>{
      document.getElementById("sidebar").classList.toggle("open");
    });
    // ✅ तुम्हारा पुराना JS (nodes, links, save/load etc.) यहां 그대로 रहेगा
    

// Simple interactive mindmap
    const stage = document.getElementById('stage');
    const edgesCanvas = document.getElementById('edges');
    const ctx = edgesCanvas.getContext('2d');
    let nodes = {}; // id => {el, x, y, w, h, title, desc, color, fontSize}
    let links = []; // [{from, to}]
    let nextId = 1;
    let mode = null; // 'connect' or 'delete' or null
    let connectFrom = null;

    function resize() {
      edgesCanvas.width = stage.clientWidth;
      edgesCanvas.height = stage.clientHeight;
      drawEdges();
    }
    window.addEventListener('resize', resize);

    function createNode(x=100,y=100,title='New Node',desc=''){
      const id = 'n'+(nextId++);
      const el = document.createElement('div');
      el.className='node';
      el.dataset.id=id;
      el.style.left = x+'px'; el.style.top = y+'px';
      el.innerHTML = `<div class="title">${escapeHtml(title)}</div>
                      <div class="meta">${escapeHtml(desc)}</div>
                      <div class="actions"><span class="handle"></span><button class='btnEdit'>Edit</button></div>`;
      stage.appendChild(el);
      nodes[id] = {el,x,y,title,desc,color:'#0ea5a4',fontSize:16};
      makeDraggable(el);
      el.addEventListener('click', e=>{ e.stopPropagation(); onNodeClick(id); });
      el.querySelector('.btnEdit').addEventListener('click', e=>{ e.stopPropagation(); openEditor(id); });
      saveToStorage();
      drawEdges();
      return id;
    }

    function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // ✅ Node connect fix
function onNodeClick(id){
  if(mode==='connect'){
    if(!connectFrom){ 
      connectFrom=id; 
      highlight(id,true); 
    } else { 
      if(connectFrom===id){ 
        highlight(id,false); 
        connectFrom=null; 
      } else { 
        // check duplicate connection
        if(!links.find(l=> (l.from===connectFrom && l.to===id) || (l.from===id && l.to===connectFrom))){
          links.push({from:connectFrom,to:id});
        }
        highlight(connectFrom,false); 
        connectFrom=null; 
        drawEdges(); 
        saveToStorage(); 
      } 
    }
    return;
  }
  if(mode==='delete'){ 
    removeNode(id); 
    return; 
  }
  populateEditor(id);
}

// ✅ Node delete fix
function removeNode(id){
  // remove links connected to this node
  links = links.filter(l=> l.from!==id && l.to!==id );
  if(nodes[id]) {
    nodes[id].el.remove(); 
    delete nodes[id]; 
  }
  drawEdges(); 
  saveToStorage();
}


    function populateEditor(id){
      const n = nodes[id];
      document.getElementById('nodeTitle').value = n.title;
      document.getElementById('nodeDesc').value = n.desc;
      document.getElementById('color').value = n.color || '#0ea5a4';
      document.getElementById('fontSize').value = n.fontSize || 16;
      stage.querySelectorAll('.node').forEach(el=>el.style.outline='');
      n.el.style.outline='2px solid rgba(124,58,237,0.18)';
      stage.dataset.selected = id;
    }

    function openEditor(id){ populateEditor(id); }

    function applyToSelected(){
      const id = stage.dataset.selected; if(!id) return alert('Koi node select karo');
      const n = nodes[id];
      n.title = document.getElementById('nodeTitle').value;
      n.desc = document.getElementById('nodeDesc').value;
      n.color = document.getElementById('color').value;
      n.fontSize = parseInt(document.getElementById('fontSize').value,10);
      n.el.querySelector('.title').innerText = n.title;
      n.el.querySelector('.meta').innerText = n.desc;
      n.el.style.borderColor = hexToRgba(n.color,0.12);
      n.el.querySelector('.title').style.fontSize = n.fontSize+'px';
      saveToStorage(); drawEdges();
    }

    function hexToRgba(hex,a){ try{ const r=parseInt(hex.slice(1,3),16);const g=parseInt(hex.slice(3,5),16);const b=parseInt(hex.slice(5,7),16);return `rgba(${r},${g},${b},${a})`; }catch(e){return hex} }

    function makeDraggable(el){
      let dragging=false,ox=0,oy=0;
      el.addEventListener('pointerdown', e=>{ e.preventDefault(); dragging=true; el.setPointerCapture(e.pointerId); ox = e.clientX - el.offsetLeft; oy = e.clientY - el.offsetTop; el.classList.add('dragging'); });
      window.addEventListener('pointermove', e=>{ if(!dragging) return; el.style.left = (e.clientX-ox)+'px'; el.style.top = (e.clientY-oy)+'px'; const id=el.dataset.id; nodes[id].x = e.clientX-ox; nodes[id].y = e.clientY-oy; drawEdges(); });
      window.addEventListener('pointerup', e=>{ if(!dragging) return; dragging=false; el.classList.remove('dragging'); el.releasePointerCapture(e.pointerId); saveToStorage(); });
    }

    function drawEdges(){
      ctx.clearRect(0,0,edgesCanvas.width,edgesCanvas.height);
      ctx.lineWidth = 2; ctx.strokeStyle = 'rgba(255,255,255,0.08)';
      links.forEach(l=>{
        const a = nodes[l.from]; const b = nodes[l.to]; if(!a||!b) return;
        const ax = a.x + a.el.offsetWidth/2 - stage.offsetLeft; const ay = a.y + a.el.offsetHeight/2 - stage.offsetTop;
        const bx = b.x + b.el.offsetWidth/2 - stage.offsetLeft; const by = b.y + b.el.offsetHeight/2 - stage.offsetTop;
        ctx.beginPath(); ctx.moveTo(ax,ay);
        const cx = (ax+bx)/2; const cy = (ay+by)/2;
        ctx.quadraticCurveTo(cx,cy, bx,by);
        ctx.stroke();
        // arrow
        const angle = Math.atan2(by - cy, bx - cx);
        const arrowX = bx - Math.cos(angle)*10; const arrowY = by - Math.sin(angle)*10;
        ctx.beginPath(); ctx.moveTo(bx,by); ctx.lineTo(arrowX - Math.sin(angle)*6, arrowY + Math.cos(angle)*6); ctx.lineTo(arrowX + Math.sin(angle)*6, arrowY - Math.cos(angle)*6); ctx.closePath(); ctx.fillStyle='rgba(255,255,255,0.08)'; ctx.fill();
      });
    }

    function highlight(id, on){ nodes[id].el.style.boxShadow = on? '0 14px 40px rgba(124,58,237,0.18)':'0 6px 20px rgba(2,6,23,0.6)'; }

    function removeNode(id){
      // remove links
      links = links.filter(l=> l.from!==id && l.to!==id );
      nodes[id].el.remove(); delete nodes[id]; drawEdges(); saveToStorage();
    }

    function saveToStorage(){
      const payload = { nodes: Object.entries(nodes).map(([id,n])=>({id,x:n.x,y:n.y,title:n.title,desc:n.desc,color:n.color,fontSize:n.fontSize})), links };
      localStorage.setItem('inspiration_mindmap', JSON.stringify(payload));
    }
    function loadFromStorage(){
      const raw = localStorage.getItem('inspiration_mindmap'); if(!raw) return;
      try{ const data=JSON.parse(raw); links = data.links || []; data.nodes.forEach(n=>{ const id = n.id; if(!id) return; // create element
          const el = document.createElement('div'); el.className='node'; el.dataset.id=id; el.style.left = n.x+'px'; el.style.top = n.y+'px'; el.innerHTML = `<div class="title">${escapeHtml(n.title)}</div><div class="meta">${escapeHtml(n.desc)}</div><div class="actions"><span class="handle"></span><button class='btnEdit'>Edit</button></div>`;
          stage.appendChild(el);
          nodes[id] = {el,x:n.x,y:n.y,title:n.title,desc:n.desc,color:n.color || '#0ea5a4',fontSize:n.fontSize ||16};
          makeDraggable(el);
          el.addEventListener('click', e=>{ e.stopPropagation(); onNodeClick(id); });
          el.querySelector('.btnEdit').addEventListener('click', e=>{ e.stopPropagation(); openEditor(id); });
          nextId = Math.max(nextId, parseInt(id.replace('n',''))+1);
      }); drawEdges(); }catch(e){console.error('load err',e)} }

    // export/import
    document.getElementById('btnExport').addEventListener('click', ()=>{
      const payload = { nodes: Object.entries(nodes).map(([id,n])=>({id,x:n.x,y:n.y,title:n.title,desc:n.desc,color:n.color,fontSize:n.fontSize})), links };
      const a = document.createElement('a'); a.href = 'data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(payload)); a.download='mindmap.json'; a.click();
    });
    document.getElementById('btnImport').addEventListener('click', ()=>{
      const input = document.createElement('input'); input.type='file'; input.accept='application/json'; input.onchange = e=>{
        const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ev=>{ try{ const data=JSON.parse(ev.target.result); clearStage(); data.nodes.forEach(n=>{ createNode(n.x,n.y,n.title,n.desc); }); links = data.links||[]; drawEdges(); saveToStorage(); }catch(err){alert('Invalid file') } }; reader.readAsText(f);
      }; input.click();
    });

    document.getElementById('btnAdd').addEventListener('click', ()=>{ createNode(60 + Math.random()*400, 60 + Math.random()*200, 'Node '+nextId, ''); });
    document.getElementById('btnConnect').addEventListener('click', ()=>{ mode = (mode==='connect')? null : 'connect'; connectFrom=null; alert(mode? 'Connect mode on: click source, then target':'Connect mode off'); });
    document.getElementById('btnDelete').addEventListener('click', ()=>{ mode = (mode==='delete')? null : 'delete'; alert(mode? 'Delete mode on: click a node to delete':'Delete mode off'); });
    document.getElementById('apply').addEventListener('click', applyToSelected);
    document.getElementById('clearAll').addEventListener('click', ()=>{ if(confirm('Clear the whole mindmap?')) clearStage(); });

    function clearStage(){ Object.keys(nodes).forEach(id=> nodes[id].el.remove()); nodes={}; links=[]; nextId=1; stage.dataset.selected=''; saveToStorage(); drawEdges(); }

    // double-click stage to add node
    document.getElementById('stage').addEventListener('dblclick', e=>{ const rect = stage.getBoundingClientRect(); const x = e.clientX - rect.left; const y = e.clientY - rect.top; createNode(x,y,'Node '+nextId,''); });

    // save button (also triggers export to backend if you want later)
    document.getElementById('btnSave').addEventListener('click', ()=>{ saveToStorage(); alert('Saved to localStorage'); });

    // click outside to deselect
    document.body.addEventListener('click', e=>{ if(!e.target.closest('.node')){ stage.dataset.selected=''; stage.querySelectorAll('.node').forEach(n=>n.style.outline=''); } });

    // load saved
    loadFromStorage();
    resize();
  </script>
</body>
</html>
